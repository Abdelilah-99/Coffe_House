<div class="profile-container container-fluid" *ngIf="profileRes">
    <!-- Multi-type Toast Message -->
    <div *ngIf="toastMessage" class="toast-message" [ngClass]="{
        'toast-success': toastMessage.type === 'success',
        'toast-error': toastMessage.type === 'error',
        'toast-warning': toastMessage.type === 'warning'}">
        <i *ngIf="toastMessage.type === 'success'" class="bi bi-check-circle-fill text-success fs-5"></i>
        <i *ngIf="toastMessage.type === 'error'" class="bi bi-x-circle-fill text-danger fs-5"></i>
        <i *ngIf="toastMessage.type === 'warning'" class="bi bi-exclamation-triangle-fill text-warning fs-5"></i>
        <span class="ms-2">{{ toastMessage.text }}</span>
        <button class="close-toast-btn btn-link p-0 ms-2" (click)="toastMessage = null">
            <i class="bi bi-x-lg text-secondary"></i>
        </button>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-info row">
            <div class="profile-avatar col-12 col-md-auto d-flex justify-content-center justify-content-md-start">
                <img *ngIf="profileRes.profileImagePath" [src]="'http://localhost:8080/' + profileRes.profileImagePath"
                    alt="Profile Picture">
                <div *ngIf="!profileRes.profileImagePath" class="avatar-placeholder">
                    {{profileRes.firstName.charAt(0)}}{{profileRes.lastName.charAt(0)}}
                </div>
            </div>
            <div class="profile-details col-12 col-md text-center text-md-start">
                <h1>{{profileRes.firstName}} {{profileRes.lastName}}</h1>
                <p class="username">&#64;{{profileRes.username}}</p>
                <p class="email">{{profileRes.email}}</p>
                <div class="profile-stats d-flex justify-content-center justify-content-md-start">
                    <div class="stat">
                        <span class="stat-value">{{followers}}</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">{{following}}</span>
                        <span class="stat-label">Following</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons for Other Users -->
        <div *ngIf="!ifCrrProfile"
            class="profile-actions d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
            <button class="btn btn-follow" *ngIf="!profileRes.connect"
                (click)="followLogic(profileRes.username, profileRes.connect)">
                Follow
            </button>
            <button class="btn btn-unfollow" *ngIf="profileRes.connect"
                (click)="followLogic(profileRes.username, profileRes.connect)">
                Unfollow
            </button>
            <button class="btn btn-report" *ngIf="!isAdmin" (click)="onReport()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z" />
                    <path
                        d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z" />
                </svg>
                Report User
            </button>
            <button class="btn btn-admin-action" *ngIf="isAdmin" (click)="onPrepareAdminBanUser()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                    <path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708" />
                </svg>
                <span *ngIf="profileRes.status === 'ACTIVE'">Ban User</span>
                <span *ngIf="profileRes.status === 'BAN'">Unban User</span>
            </button>
        </div>

        <!-- Report Section -->
        <div *ngIf="reportAction" class="report-section">
            <div class="report-header">
                <h3>Report User</h3>
                <button class="close-btn" (click)="onReport()">âœ•</button>
            </div>
            <textarea name="reportProfile" placeholder="Describe why you're reporting this user..."
                #reportData></textarea>
            <div class="report-actions">
                <button class="btn btn-cancel" (click)="onReport()">Cancel</button>
                <button class="btn btn-submit" (click)="onPrepareSubmitReport(profileRes.uuid, reportData.value)">
                    <span class="btn-icon">ðŸš¨</span>
                    Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Popup -->
    <div *ngIf="showReportConfirmation" class="confirmation-overlay" (click)="onCancelReport()">
        <div class="confirmation-dialog" (click)="$event.stopPropagation()">
            <div class="confirmation-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z" />
                    <path
                        d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z" />
                </svg>
            </div>
            <h3 class="confirmation-title">Submit User Report?</h3>
            <p class="confirmation-message">
                Are you sure you want to submit this report? Our moderation team will be notified and will review this
                user's behavior for policy violations.
            </p>
            <div class="confirmation-actions">
                <button class="btn-confirmation-cancel" (click)="onCancelReport()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                        <path
                            d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708" />
                    </svg>
                    Cancel
                </button>
                <button class="btn-confirmation-confirm" (click)="onConfirmReport()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2" />
                    </svg>
                    Yes, Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Ban User Confirmation Dialog -->
    <div *ngIf="showAdminBanConfirmation" class="confirmation-overlay" (click)="onCancelAdminBanUser()">
        <div class="confirmation-dialog" (click)="$event.stopPropagation()">
            <div class="confirmation-icon ban-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                    <path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708" />
                </svg>
            </div>
            <h3 class="confirmation-title" *ngIf="profileRes?.status === 'ACTIVE'">Ban User?</h3>
            <h3 class="confirmation-title" *ngIf="profileRes?.status === 'BAN'">Unban User?</h3>
            <p class="confirmation-message" *ngIf="profileRes?.status === 'ACTIVE'">
                Are you sure you want to ban <strong>{{profileRes.firstName}} {{profileRes.lastName}}</strong>
                (@{{profileRes.username}})? This will prevent them from accessing the platform.
            </p>
            <p class="confirmation-message" *ngIf="profileRes?.status === 'BAN'">
                Are you sure you want to unban <strong>{{profileRes.firstName}} {{profileRes.lastName}}</strong>
                (@{{profileRes.username}})? This will restore their access to the platform.
            </p>
            <div class="confirmation-actions">
                <button class="btn-confirmation-cancel" (click)="onCancelAdminBanUser()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                        <path
                            d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708" />
                    </svg>
                    Cancel
                </button>
                <button class="btn-confirmation-confirm btn-ban-confirm" (click)="onConfirmAdminBanUser()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                        <path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708" />
                    </svg>
                    <span *ngIf="profileRes?.status === 'ACTIVE'">Yes, Ban User</span>
                    <span *ngIf="profileRes?.status === 'BAN'">Yes, Unban User</span>
                </button>
            </div>
        </div>
    </div>

    <!-- User Posts Section -->
    <div class="user-posts-section">
        <h2>Posts</h2>
        <div *ngIf="isLoadingPosts" class="loading">
            Loading posts...
        </div>
        <div *ngIf="!isLoadingPosts && userPosts.length === 0" class="no-posts">
            <p>No posts yet</p>
        </div>
        <div *ngIf="!isLoadingPosts && userPosts.length > 0" class="posts-grid row">
            <div *ngFor="let post of userPosts" class="col-12 col-md-6 col-lg-4 mb-4">
                <div class="post-card" (click)="navigateToPost(post.postUuid)">
                    <!-- Post with image(s) - Image as background with overlay -->
                    <div *ngIf="post.mediaPaths && post.mediaPaths.length > 0" class="post-with-image">
                        <div class="post-image-wrapper">
                            <img [src]="'http://localhost:8080/' + post.mediaPaths[0].path" alt="{{ post.title }}"
                                class="post-bg-image">
                            <div class="post-image-overlay">
                                <h3 class="post-title-overlay">{{post.title}}</h3>
                            </div>
                        </div>
                        <div class="post-footer-info">
                            <div class="post-author-compact">
                                <div class="author-avatar-small">
                                    <img *ngIf="profileRes?.profileImagePath"
                                        [src]="'http://localhost:8080/' + profileRes.profileImagePath" alt="Profile">
                                    <div *ngIf="!profileRes?.profileImagePath" class="avatar-placeholder-small">
                                        {{profileRes.firstName.charAt(0) || ''}}
                                    </div>
                                </div>
                                <span class="author-name">{{post.userName}}</span>
                                <span class="post-time">{{post.createdAt | date: 'short'}}</span>
                            </div>
                            <div class="post-actions" (click)="$event.stopPropagation()">
                                <button class="action-btn like-btn" (click)="handleLike($event, post.postUuid)">
                                    <img src="/coffe-like.png" alt="Like" class="icon">
                                    <span>{{post.likeCount}}</span>
                                </button>
                                <button class="action-btn comment-btn" (click)="navigateToPost(post.postUuid)">
                                    <img src="/coffe-comment.png" alt="Comment" class="icon">
                                    <span class="count">{{post.commentCount}}</span>
                                    <span class="text">Comments</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Post without image - Traditional layout -->
                    <div *ngIf="!post.mediaPaths || post.mediaPaths.length === 0" class="post-no-image">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar-small">
                                    <img *ngIf="profileRes?.profileImagePath"
                                        [src]="'http://localhost:8080/' + profileRes.profileImagePath" alt="Profile">
                                    <div *ngIf="!profileRes?.profileImagePath" class="avatar-placeholder-small">
                                        {{profileRes.firstName.charAt(0) || ''}}
                                    </div>
                                </div>
                                <div class="author-info">
                                    <span class="author-name">{{post.userName}}</span>
                                    <span class="post-time">{{post.createdAt | date: 'short'}}</span>
                                </div>
                            </div>
                        </div>

                        <div class="post-content">
                            <h3>{{post.title}}</h3>
                            <p class="post-preview">{{post.content}}</p>
                        </div>

                        <div class="post-actions" (click)="$event.stopPropagation()">
                            <button class="action-btn like-btn" (click)="handleLike($event, post.postUuid)">
                                <img src="/coffe-like.png" alt="Like" class="icon">
                                <span>{{post.likeCount}}</span>
                            </button>
                            <button class="action-btn comment-btn" (click)="navigateToPost(post.postUuid)">
                                <img src="/coffe-comment.png" alt="Comment" class="icon">
                                <span class="count">{{post.commentCount}}</span>
                                <span class="text">Comments</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>